import streamlit as st
import pandas as pd
from io import StringIO
import altair as alt # Streamlitì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì§€ì›í•˜ëŠ” ì‹œê°í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë³„ë„ ì„¤ì¹˜ í•„ìš” ì—†ìŒ)

# 1. ë°ì´í„° ì¤€ë¹„ (CSV íŒŒì¼ì„ ì½”ë“œë¡œ ì§ì ‘ ê°€ì ¸ì˜´)
csv_data = """
ì—°ë ¹ëŒ€,1ìœ„ ìŒë£Œ,2ìœ„ ìŒë£Œ,3ìœ„ ìŒë£Œ,4ìœ„ ìŒë£Œ,5ìœ„ ìŒë£Œ
10ëŒ€,ì•„ë©”ë¦¬ì¹´ë…¸,ì¹´í˜ ë¼ë–¼,ìë°” ì¹© í”„ë¼í‘¸ì¹˜ë…¸,ì¹´ë¼ë©œ ë§ˆë¼ì•„ë˜,í™”ì´íŠ¸ ì´ˆì½œë¦¿ ëª¨ì¹´
20ëŒ€,ì•„ë©”ë¦¬ì¹´ë…¸,ì¹´í˜ ë¼ë–¼,ìëª½ í—ˆë‹ˆ ë¸”ë™ í‹°,ëŒì²´ ì½œë“œ ë¸Œë£¨,ì¹´í˜ ëª¨ì¹´
30~40ëŒ€,ì•„ë©”ë¦¬ì¹´ë…¸,ì¹´í˜ ë¼ë–¼,ëŒì²´ ì½œë“œ ë¸Œë£¨ / ëŒì²´ ë¼ë–¼,ì¹´í˜ ëª¨ì¹´,ìë°” ì¹© í”„ë¼í‘¸ì¹˜ë…¸
50ëŒ€ ì´ìƒ,ë””ì¹´í˜ì¸ ì•„ë©”ë¦¬ì¹´ë…¸,ì¹´í˜ ë¼ë–¼,ì¹´í˜ ëª¨ì¹´,ìëª½ í—ˆë‹ˆ ë¸”ë™ í‹°,ëŒì²´ ì½œë“œ ë¸Œë£¨
"""

# StringIOë¥¼ ì´ìš©í•´ ë¬¸ìì—´ ë°ì´í„°ë¥¼ Pandas DataFrameìœ¼ë¡œ ë³€í™˜
df_raw = pd.read_csv(StringIO(csv_data))
RANK_COLUMNS = ['1ìœ„ ìŒë£Œ', '2ìœ„ ìŒë£Œ', '3ìœ„ ìŒë£Œ', '4ìœ„ ìŒë£Œ', '5ìœ„ ìŒë£Œ']

# 2. Streamlit ì•± ì„¤ì •
def run_app_with_chart():
    st.title("ğŸ“Š ì—°ë ¹ëŒ€ë³„ ìŠ¤íƒ€ë²…ìŠ¤ TOP 5 ìŒë£Œ ì°¨íŠ¸ ë¶„ì„! âœ¨")
    st.markdown("---")
    
    st.header("ğŸ•µï¸â€â™€ï¸ ë„¤ ì·¨í–¥ì„ ë°ì´í„°ë¡œ í™•ì¸í•´ë´!")
    st.subheader("ì•„ë˜ì—ì„œ ì—°ë ¹ëŒ€ë¥¼ ê³ ë¥´ë©´ ë­í‚¹ì´ ê·¸ë˜í”„ë¡œ ë‚˜íƒ€ë‚  ê±°ì•¼.")

    # ì—°ë ¹ëŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë©”ë‰´
    age_groups = df_raw['ì—°ë ¹ëŒ€'].unique().tolist()
    
    selected_age = st.selectbox(
        'ğŸ‘‡ í•´ë‹¹ë˜ëŠ” ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•´ì¤˜!',
        options=['ì—°ë ¹ëŒ€ ì„ íƒ'] + age_groups,
        index=0
    )

    # 3. ê²°ê³¼ í‘œì‹œ ë° ì°¨íŠ¸ ìƒì„±
    if selected_age == 'ì—°ë ¹ëŒ€ ì„ íƒ':
        st.info("ğŸ‘ˆ ì—°ë ¹ëŒ€ë¥¼ ê³¨ë¼ì•¼ ë©‹ì§„ ê·¸ë˜í”„ë¥¼ ë³¼ ìˆ˜ ìˆì–´! ğŸ¤©")
        
    else:
        st.success(f"ğŸ‰ **{selected_age}**ì˜ ì¸ê¸° ìŒë£Œ ë­í‚¹ì´ì•¼! í•œë²ˆ ë³´ì! ğŸš€")
        
        # ì„ íƒëœ ì—°ë ¹ëŒ€ì˜ ë°ì´í„° ì¶”ì¶œ
        result = df_raw[df_raw['ì—°ë ¹ëŒ€'] == selected_age].iloc[0]
        
        # ì°¨íŠ¸ìš© ë°ì´í„°í”„ë ˆì„ ìƒì„±
        chart_data = pd.DataFrame({
            'ìˆœìœ„': [1, 2, 3, 4, 5],
            'ìŒë£Œ': [result[col] for col in RANK_COLUMNS]
        })

        # ìˆœìœ„ê°€ ë‚®ì•„ì§ˆìˆ˜ë¡(ìˆœìœ„ ë²ˆí˜¸ê°€ ë†’ì•„ì§ˆìˆ˜ë¡) ì—°í•´ì§€ëŠ” ì§™ì€ ì´ˆë¡ìƒ‰ ê·¸ë¼ë°ì´ì…˜ ì„¤ì •
        # (ìƒ‰ìƒ ì½”ë“œëŠ” ì„ì˜ë¡œ ì§„í•œ ì´ˆë¡ìƒ‰ ê³„ì—´ë¡œ ì„¤ì •í•¨)
        color_scale = alt.Scale(
            domain=[1, 5], 
            range=['#1E8449', '#27AE60', '#2ECC71', '#58D68D', '#82E0AA'] # ì§„í•œ ì´ˆë¡ -> ì—°í•œ ì´ˆë¡
        )

        # Altair ì°¨íŠ¸ ìƒì„± (ë§‰ëŒ€ ê·¸ë˜í”„)
        chart = alt.Chart(chart_data).mark_bar().encode(
            # Xì¶•: ìŒë£Œ ì´ë¦„ (ë„ìš°ê¸° ì¢‹ê²Œ)
            x=alt.X('ìŒë£Œ', sort=None, axis=alt.Axis(labelAngle=0, title=None)), 
            # Yì¶•: ìˆœìœ„ (ë§‰ëŒ€ì˜ ê¸¸ì´ë¥¼ ìˆœìœ„ë¡œ í‘œí˜„)
            y=alt.Y('ìˆœìœ„', sort="descending", axis=alt.Axis(title='ìˆœìœ„ (Rank)', tickCount=5)),
            # ë§‰ëŒ€ ìƒ‰ìƒ: ìˆœìœ„ì— ë”°ë¥¸ ê·¸ë¼ë°ì´ì…˜ ì ìš©
            color=alt.Color('ìˆœìœ„', scale=color_scale, legend=None),
            # íˆ´íŒ: ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ìˆœìœ„ì™€ ìŒë£Œê°€ ë³´ì´ë„ë¡ ì„¤ì •
            tooltip=['ìˆœìœ„', 'ìŒë£Œ']
        ).properties(
            title=f'{selected_age} ì„ í˜¸ ìŒë£Œ TOP 5'
        ).interactive() # ì°¨íŠ¸ë¥¼ í™•ëŒ€/ì¶•ì†Œ ê°€ëŠ¥í•˜ê²Œ

        # ìŠ¤íŠ¸ë¦¼ë¦¿ì— ì°¨íŠ¸ ë„ìš°ê¸°
        st.altair_chart(chart, use_container_width=True)
        
        st.markdown("---")
        st.markdown("**ğŸ“Œ íŒ:** ìˆœìœ„ê°€ ë†’ì„ìˆ˜ë¡ (1ìœ„) ë§‰ëŒ€ ìƒ‰ê¹”ì´ **ë” ì§„í•œ ì´ˆë¡ìƒ‰**ì´ì•¼!")
        
        st.balloons() # ê·¸ë˜í”„ê°€ ë‚˜ì˜¤ë©´ í’ì„  íš¨ê³¼ ì¶”ê°€! ğŸˆ

# ì•± ì‹¤í–‰
if __name__ == "__main__":
    run_app_with_chart()
